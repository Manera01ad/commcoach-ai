{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/Hp/.gemini/antigravity/scratch/commcoach-ai/qa-dashboard/src/app/api/saas-metrics/route.ts"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\r\nimport { NextResponse } from 'next/server';\r\n\r\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!;\r\nconst supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!;\r\n\r\nconst supabase = createClient(supabaseUrl, supabaseAnonKey);\r\n\r\nexport async function GET() {\r\n    try {\r\n        // Fetch current MRR from view\r\n        const { data: mrrData, error: mrrError } = await supabase\r\n            .from('current_mrr')\r\n            .select('*')\r\n            .single();\r\n\r\n        if (mrrError && mrrError.code !== 'PGRST116') {\r\n            console.error('MRR fetch error:', mrrError);\r\n        }\r\n\r\n        // Fetch active users count\r\n        const { count: activeUsersCount, error: activeUsersError } = await supabase\r\n            .from('user_subscriptions')\r\n            .select('*', { count: 'exact', head: true })\r\n            .eq('status', 'active')\r\n            .gte('current_period_end', new Date().toISOString());\r\n\r\n        if (activeUsersError) {\r\n            console.error('Active users error:', activeUsersError);\r\n        }\r\n\r\n        // Fetch total users count\r\n        const { count: totalUsersCount, error: totalUsersError } = await supabase\r\n            .from('user_subscriptions')\r\n            .select('*', { count: 'exact', head: true });\r\n\r\n        if (totalUsersError) {\r\n            console.error('Total users error:', totalUsersError);\r\n        }\r\n\r\n        // Fetch token usage for current month\r\n        const startOfMonth = new Date();\r\n        startOfMonth.setDate(1);\r\n        startOfMonth.setHours(0, 0, 0, 0);\r\n\r\n        const { data: tokenData, error: tokenError } = await supabase\r\n            .from('token_usage')\r\n            .select('tokens_used, cost_usd')\r\n            .gte('created_at', startOfMonth.toISOString());\r\n\r\n        if (tokenError) {\r\n            console.error('Token usage error:', tokenError);\r\n        }\r\n\r\n        const totalTokens = tokenData?.reduce((sum, row) => sum + row.tokens_used, 0) || 0;\r\n        const totalCost = tokenData?.reduce((sum, row) => sum + (row.cost_usd || 0), 0) || 0;\r\n\r\n        // Fetch open support tickets\r\n        const { count: openTicketsCount, error: ticketsError } = await supabase\r\n            .from('support_tickets')\r\n            .select('*', { count: 'exact', head: true })\r\n            .in('status', ['open', 'in_progress']);\r\n\r\n        if (ticketsError) {\r\n            console.error('Support tickets error:', ticketsError);\r\n        }\r\n\r\n        // Fetch banned users count\r\n        const { count: bannedUsersCount, error: bannedError } = await supabase\r\n            .from('user_moderation')\r\n            .select('*', { count: 'exact', head: true })\r\n            .eq('status', 'banned');\r\n\r\n        if (bannedError) {\r\n            console.error('Banned users error:', bannedError);\r\n        }\r\n\r\n        // Fetch revenue for current month\r\n        const { data: revenueData, error: revenueError } = await supabase\r\n            .from('revenue_transactions')\r\n            .select('amount')\r\n            .eq('payment_status', 'completed')\r\n            .gte('created_at', startOfMonth.toISOString());\r\n\r\n        if (revenueError) {\r\n            console.error('Revenue error:', revenueError);\r\n        }\r\n\r\n        const monthlyRevenue = revenueData?.reduce((sum, row) => sum + parseFloat(row.amount.toString()), 0) || 0;\r\n\r\n        // Fetch last month's MRR for growth calculation\r\n        const lastMonth = new Date();\r\n        lastMonth.setMonth(lastMonth.getMonth() - 1);\r\n\r\n        const { data: lastMonthMetrics, error: lastMonthError } = await supabase\r\n            .from('saas_metrics_daily')\r\n            .select('mrr')\r\n            .gte('date', lastMonth.toISOString().split('T')[0])\r\n            .lt('date', startOfMonth.toISOString().split('T')[0])\r\n            .order('date', { ascending: false })\r\n            .limit(1)\r\n            .single();\r\n\r\n        if (lastMonthError && lastMonthError.code !== 'PGRST116') {\r\n            console.error('Last month metrics error:', lastMonthError);\r\n        }\r\n\r\n        const currentMrr = mrrData?.mrr || 0;\r\n        const lastMonthMrr = lastMonthMetrics?.mrr || currentMrr;\r\n        const mrrGrowth = lastMonthMrr > 0\r\n            ? ((currentMrr - lastMonthMrr) / lastMonthMrr) * 100\r\n            : 0;\r\n\r\n        // Calculate revenue per token\r\n        const revenuePerToken = totalCost > 0 ? currentMrr / totalCost : 0;\r\n\r\n        // Fetch subscription breakdown\r\n        const { data: subscriptionBreakdown, error: breakdownError } = await supabase\r\n            .from('user_subscriptions')\r\n            .select(`\r\n        plan_id,\r\n        subscription_plans (\r\n          display_name,\r\n          price_monthly\r\n        )\r\n      `)\r\n            .eq('status', 'active');\r\n\r\n        if (breakdownError) {\r\n            console.error('Subscription breakdown error:', breakdownError);\r\n        }\r\n\r\n        // Group by plan\r\n        const planCounts: Record<string, { count: number; revenue: number; name: string }> = {};\r\n        subscriptionBreakdown?.forEach((sub: any) => {\r\n            const planName = sub.subscription_plans?.display_name || 'Unknown';\r\n            const planRevenue = parseFloat(sub.subscription_plans?.price_monthly || 0);\r\n\r\n            if (!planCounts[planName]) {\r\n                planCounts[planName] = { count: 0, revenue: 0, name: planName };\r\n            }\r\n            planCounts[planName].count++;\r\n            planCounts[planName].revenue += planRevenue;\r\n        });\r\n\r\n        const summaries = Object.values(planCounts).map(plan => ({\r\n            type: plan.name,\r\n            count: plan.count,\r\n            passRate: plan.revenue,\r\n            lastRun: new Date().toISOString()\r\n        }));\r\n\r\n        // Fetch recent alerts (high-value signups, payment failures, etc.)\r\n        const { data: recentTransactions, error: alertsError } = await supabase\r\n            .from('revenue_transactions')\r\n            .select('*')\r\n            .order('created_at', { ascending: false })\r\n            .limit(10);\r\n\r\n        if (alertsError) {\r\n            console.error('Alerts error:', alertsError);\r\n        }\r\n\r\n        const alerts = recentTransactions?.map((txn: any) => ({\r\n            id: txn.id,\r\n            message: txn.payment_status === 'completed'\r\n                ? `New payment: $${txn.amount} via ${txn.payment_gateway}`\r\n                : `Payment ${txn.payment_status}: $${txn.amount}`,\r\n            type: txn.payment_status === 'completed' ? 'success' :\r\n                txn.payment_status === 'failed' ? 'critical' : 'warning',\r\n            timestamp: txn.created_at\r\n        })) || [];\r\n\r\n        // Fetch trends data (last 7 days)\r\n        const sevenDaysAgo = new Date();\r\n        sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);\r\n\r\n        const { data: trendsData, error: trendsError } = await supabase\r\n            .from('saas_metrics_daily')\r\n            .select('*')\r\n            .gte('date', sevenDaysAgo.toISOString().split('T')[0])\r\n            .order('date', { ascending: true });\r\n\r\n        if (trendsError) {\r\n            console.error('Trends error:', trendsError);\r\n        }\r\n\r\n        const trends = trendsData?.map((day: any) => ({\r\n            date: new Date(day.date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }),\r\n            infrastructure: day.mrr,\r\n            therapy: day.total_token_cost,\r\n            journey: day.active_users,\r\n            performance: day.revenue_today,\r\n            security: day.open_tickets\r\n        })) || [];\r\n\r\n        // Generate AI recommendations based on data\r\n        const recommendations: Array<{\r\n            priority: 'High' | 'Medium' | 'Low';\r\n            action: string;\r\n            rationale: string;\r\n        }> = [];\r\n\r\n        // Check for high token usage\r\n        if (totalCost > 0 && revenuePerToken < 5) {\r\n            recommendations.push({\r\n                priority: 'High' as const,\r\n                action: 'Optimize Token Cost',\r\n                rationale: `Revenue per token is ${revenuePerToken.toFixed(2)}x. Consider optimizing AI model usage.`\r\n            });\r\n        }\r\n\r\n        // Check for open tickets\r\n        if ((openTicketsCount || 0) > 10) {\r\n            recommendations.push({\r\n                priority: 'Medium' as const,\r\n                action: 'Review Support Load',\r\n                rationale: `${openTicketsCount} open tickets. Consider scaling support team.`\r\n            });\r\n        }\r\n\r\n        // Check for growth\r\n        if (mrrGrowth < 5) {\r\n            recommendations.push({\r\n                priority: 'High' as const,\r\n                action: 'Accelerate Growth',\r\n                rationale: `MRR growth is ${mrrGrowth.toFixed(1)}%. Focus on acquisition and retention.`\r\n            });\r\n        }\r\n\r\n        // Calculate overall health score\r\n        const healthFactors = [\r\n            mrrGrowth > 10 ? 100 : mrrGrowth * 5, // Growth factor\r\n            (activeUsersCount || 0) > 100 ? 100 : (activeUsersCount || 0), // User base\r\n            revenuePerToken > 5 ? 100 : revenuePerToken * 20, // Unit economics\r\n            (openTicketsCount || 0) < 10 ? 100 : 100 - ((openTicketsCount || 0) * 5) // Support health\r\n        ];\r\n        const overallHealth = healthFactors.reduce((a, b) => a + b, 0) / healthFactors.length;\r\n\r\n        return NextResponse.json({\r\n            success: true,\r\n            data: {\r\n                mrr: currentMrr,\r\n                mrrGrowth: parseFloat(mrrGrowth.toFixed(2)),\r\n                activeUsers: activeUsersCount || 0,\r\n                totalUsers: totalUsersCount || 0,\r\n                tokenSpend: parseFloat(totalCost.toFixed(2)),\r\n                revenuePerToken: parseFloat(revenuePerToken.toFixed(2)),\r\n                openTickets: openTicketsCount || 0,\r\n                bannedUsers: bannedUsersCount || 0,\r\n                overallHealth: parseFloat(overallHealth.toFixed(1)),\r\n                trends,\r\n                alerts,\r\n                summaries,\r\n                recommendations\r\n            }\r\n        });\r\n\r\n    } catch (error: any) {\r\n        console.error('SaaS metrics API error:', error);\r\n        return NextResponse.json(\r\n            {\r\n                success: false,\r\n                error: error.message || 'Failed to fetch SaaS metrics',\r\n                data: null\r\n            },\r\n            { status: 500 }\r\n        );\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}